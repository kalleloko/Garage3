@model PagedResult<Garage3.Models.VehicleRowViewModel>

@{
    ViewData["Title"] = "HomePage";
}
@if (TempData["Message"] != null)
{
    <div id="alertMessage" class="alert alert-success position-absolute z-1 start-50 rounded">
        @TempData["Message"]
    </div>
}
<div class="mb-3 d-flex flex-row justify-content-between">
    <a asp-action="Create" class="btn btn-primary">Check in a vehicle </a>
    <form asp-action="HomePage" method="get" class="d-flex flex-row w-50">
        <div class="input-group">
            <input type="text" name="search" value="@ViewData["CurrentFilter"]" class="form-control w-auto" placeholder="Search by registration number..." />
            <dropdown items="@ViewData["TypesSelectList"] as IEnumerable<SelectListItem> ?? Enumerable.Empty<SelectListItem>()" name="Type" selected="@ViewData["CurrentType"]" class="form-control" style="width: 40px;">
                <option value="">All types</option>
            </dropdown>
            <input type="hidden" name="sort" value="@ViewData["CurrentSort"]" />
            <button type="submit" class="btn btn-primary">Search</button>
        </div>
    </form>
</div>

<table class="table table-striped table-bordered">
    <thead class="table-dark">
        <tr>
            @if (User.IsInRole("Admin"))
            {
                <th>
                    <a asp-action="HomePage"
                       asp-route-sort="@ViewData["OwnerSortParam"]"
                       asp-route-search="@ViewData["CurrentFilter"]"
                       asp-route-type="@ViewData["CurrentType"]"
                       class="text-decoration-none text-white">
                        Owner
                    </a>

                </th>
            }
            <th>
                <a asp-action="HomePage"
                   asp-route-sort="@ViewData["TypeSortParam"]"
                   asp-route-search="@ViewData["CurrentFilter"]"
                   asp-route-type="@ViewData["CurrentType"]"
                   class="text-decoration-none text-white">
                    @Html.DisplayNameFor(model => model.Items.First().Type)
                    @if (ViewData["CurrentSort"]?.ToString() == "Type")
                    {
                        <i class="bi bi-arrow-up text-white"></i>
                    }
                    else if (ViewData["CurrentSort"]?.ToString() == "Type_desc")
                    {
                        <i class="bi bi-arrow-down text-white"></i>
                    }
                </a>

            </th>
            <th>
                <a asp-action="HomePage"
                   asp-route-sort="@ViewData["RegSortParam"]"
                   asp-route-search="@ViewData["CurrentFilter"]"
                   asp-route-type="@ViewData["CurrentType"]"
                   class="text-decoration-none text-white">
                    @Html.DisplayNameFor(model => model.Items.First().RegistrationNumber)
                    @if (ViewData["CurrentSort"]?.ToString() == "RegistrationNumber")
                    {
                        <i class="bi bi-arrow-up text-white"></i>
                    }
                    else if (ViewData["CurrentSort"]?.ToString() == "RegistrationNumber_desc")
                    {
                        <i class="bi bi-arrow-down text-white"></i>
                    }
                </a>
            </th>
            <th>
                <a asp-action="HomePage"
                   asp-route-sort="@ViewData["ArrivalSortParam"]"
                   asp-route-search="@ViewData["ArrivalSortParam"]"
                   asp-route-type="@ViewData["CurrentFilter"]"
                   class="text-decoration-none text-white">
                    @Html.DisplayNameFor(model => model.Items.First().ArrivalTime)
                    @if (ViewData["CurrentSort"]?.ToString() == "ArrivalTime")
                    {
                        <i class="bi bi-arrow-up text-white"></i>
                    }
                    else if (ViewData["CurrentSort"]?.ToString() == "ArrivalTime_desc")
                    {
                        <i class="bi bi-arrow-down text-white"></i>
                    }
                </a>
            </th>
            <th>
                <a asp-action="HomePage"
                   asp-route-sort="@ViewData["ParkingTimeSortParam"]"
                   asp-route-search="@ViewData["CurrentFilter"]"
                   asp-route-type="@ViewData["CurrentType"]"
                   class="text-decoration-none text-white">
                    @Html.DisplayNameFor(model => model.Items.First().ParkedTime)
                    @if (ViewData["CurrentSort"]?.ToString() == "ParkingTime")
                    {
                        <i class="bi bi-arrow-up text-white"></i>
                    }
                    else if (ViewData["CurrentSort"]?.ToString() == "ParkingTime_desc")
                    {
                        <i class="bi bi-arrow-down text-white"></i>
                    }
                </a>
            </th>
            <th>Actions</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var item in Model.Items)
        {
            <tr>
                @if (User.IsInRole("Admin"))
                {
                    <td>
                        @item.OwnerName <br /><small class="text-secondary">@item.OwnerEmail</small>
                    </td>
                }
                <td>
                    @item.Type.Name
                </td>
                <td>
                    @item.RegistrationNumber
                </td>
                <td>
                    @item.ArrivalTime
                </td>
                <td>
                    @item.ParkedTimeDisplay
                </td>
                <td>
                    <a asp-action="VehicleDetail" asp-route-id="@item.Id" class="btn btn-info btn-sm">Details</a>
                    <a asp-action="Edit" asp-route-id="@item.Id" class="btn btn-warning btn-sm">Edit</a>
                    @if(item.ArrivalTime != null) {
                        <a asp-action="Delete" asp-route-id="@item.Id" class="btn btn-secondary btn-sm">Pick up</a>
                    }
                </td>
            </tr>
        }
    </tbody>
</table>
<nav>
    <ul class="pagination justify-content-center">

        <li class="page-item @(Model.HasPrevious ? "" : "disabled")">
            <a class="page-link"
               asp-action="HomePage"
               asp-route-page="@(Model.PageNumber - 1)">
                Previous
            </a>
        </li>

        @for (int i = 1; i <= Model.TotalPages; i++)
        {
            <li class="page-item @(i == Model.PageNumber ? "active" : "")">
                <a class="page-link"
                   asp-action="HomePage"
                   asp-route-page="@i">
                    @i
                </a>
            </li>
        }

        <li class="page-item @(Model.HasNext ? "" : "disabled")">
            <a class="page-link"
               asp-action="HomePage"
               asp-route-page="@(Model.PageNumber + 1)">
                Next
            </a>
        </li>

    </ul>
</nav>
<script>
    window.onload = function() {
        const alert = document.getElementById("alertMessage");
        if (alert) {
            // hide after 3 seconds (3000 ms)
            setTimeout(() => {
                alert.style.transition = "opacity 1s";
                alert.style.opacity = 0;
                setTimeout(() => alert.remove(), 1000); // remove from DOM
            }, 3000);
        }
    };
</script>
@if(ViewBag.Receipt != null)
{
    @await Html.PartialAsync("_Receipt", (Receipt)ViewBag.Receipt)
}

@if(!User.Identity.IsAuthenticated)
{
    <p>Hi, please login</p>
}

@if(User.Identity.IsAuthenticated)
{
    if(User.IsInRole("Member"))
    {
        <p>Hello, Member</p>
    }
    else if (User.IsInRole("Admin"))
    {
        <p>Hello Admin</p>
    } else
    {
        <p>Hello User</p>
    }
}
